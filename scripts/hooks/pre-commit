#!/bin/bash
#
# Pre-commit hook for Morpheus Go project
# Runs formatting, linting, and basic checks before allowing commits
#
# To skip this hook (not recommended), run: git commit --no-verify

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any check fails
FAILED=0

echo "๐ Running pre-commit checks..."
echo ""

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

# Check if there are any Go files to check
if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${YELLOW}โญ  No Go files staged, skipping Go-specific checks${NC}"
else
    # 1. Check gofmt
    echo "๐ Checking Go formatting..."
    UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>&1 || true)
    if [ -n "$UNFORMATTED" ]; then
        echo -e "${RED}โ The following files need formatting:${NC}"
        echo "$UNFORMATTED"
        echo ""
        echo "Run 'make fmt' to fix"
        FAILED=1
    else
        echo -e "${GREEN}โ Go formatting OK${NC}"
    fi

    # 2. Run go vet
    echo ""
    echo "๐ฌ Running go vet..."
    if ! go vet ./... 2>&1; then
        echo -e "${RED}โ go vet found issues${NC}"
        FAILED=1
    else
        echo -e "${GREEN}โ go vet OK${NC}"
    fi

    # 3. Check go mod tidy
    echo ""
    echo "๐ฆ Checking go.mod tidiness..."
    cp go.mod go.mod.backup
    cp go.sum go.sum.backup 2>/dev/null || true
    go mod tidy
    if ! diff -q go.mod go.mod.backup > /dev/null 2>&1; then
        echo -e "${RED}โ go.mod is not tidy. Run 'go mod tidy' and commit the changes${NC}"
        mv go.mod.backup go.mod
        mv go.sum.backup go.sum 2>/dev/null || true
        FAILED=1
    else
        mv go.mod.backup go.mod
        mv go.sum.backup go.sum 2>/dev/null || true
        echo -e "${GREEN}โ go.mod is tidy${NC}"
    fi
fi

# 4. Check for build errors
echo ""
echo "๐จ Checking if code compiles..."
if ! go build ./... 2>&1; then
    echo -e "${RED}โ Build failed${NC}"
    FAILED=1
else
    echo -e "${GREEN}โ Build OK${NC}"
fi

# 5. Check for common secrets patterns in staged files
echo ""
echo "๐ Checking for potential secrets..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
SECRET_PATTERNS=(
    'PRIVATE.KEY'
    'BEGIN RSA PRIVATE KEY'
    'BEGIN DSA PRIVATE KEY'
    'BEGIN EC PRIVATE KEY'
    'BEGIN OPENSSH PRIVATE KEY'
    'BEGIN PGP PRIVATE KEY'
    'password\s*=\s*["\x27][^"\x27]{8,}["\x27]'
    'api[_-]?key\s*=\s*["\x27][^"\x27]{16,}["\x27]'
    'secret[_-]?key\s*=\s*["\x27][^"\x27]{16,}["\x27]'
    'AWS_SECRET_ACCESS_KEY'
    'HCLOUD_TOKEN\s*=\s*["\x27][^"\x27]+["\x27]'
)

SECRETS_FOUND=0
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -qiE "$pattern" "$file" 2>/dev/null; then
                # Skip example and test files
                if [[ "$file" != *".example"* ]] && [[ "$file" != *"_test.go" ]] && [[ "$file" != *".example.yaml" ]]; then
                    echo -e "${RED}โ Potential secret found in $file (pattern: $pattern)${NC}"
                    SECRETS_FOUND=1
                fi
            fi
        done
    fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
    echo -e "${YELLOW}โ  Review the above files for sensitive data${NC}"
    FAILED=1
else
    echo -e "${GREEN}โ No obvious secrets detected${NC}"
fi

# 6. Check for large files (> 500KB)
echo ""
echo "๐ Checking for large files..."
LARGE_FILES=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 512000 ]; then
            LARGE_FILES="$LARGE_FILES\n  $file ($(numfmt --to=iec $SIZE 2>/dev/null || echo "${SIZE}B"))"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}โ  Large files detected (>500KB):${NC}"
    echo -e "$LARGE_FILES"
    echo "Consider if these should be committed"
else
    echo -e "${GREEN}โ No large files${NC}"
fi

# 7. Check for trailing whitespace in Go files
echo ""
echo "๐งน Checking for trailing whitespace..."
TRAILING_WS=""
for file in $STAGED_GO_FILES; do
    if [ -f "$file" ]; then
        if grep -qE '\s+$' "$file" 2>/dev/null; then
            TRAILING_WS="$TRAILING_WS $file"
        fi
    fi
done

if [ -n "$TRAILING_WS" ]; then
    echo -e "${YELLOW}โ  Trailing whitespace found in:${NC}"
    echo "$TRAILING_WS"
else
    echo -e "${GREEN}โ No trailing whitespace${NC}"
fi

# 8. Check for TODO/FIXME markers (informational only)
echo ""
echo "๐ Checking for TODO/FIXME markers..."
TODO_COUNT=0
for file in $STAGED_GO_FILES; do
    if [ -f "$file" ]; then
        COUNT=$(grep -cE '(TODO|FIXME|XXX|HACK):' "$file" 2>/dev/null || echo 0)
        TODO_COUNT=$((TODO_COUNT + COUNT))
    fi
done

if [ $TODO_COUNT -gt 0 ]; then
    echo -e "${YELLOW}โน  Found $TODO_COUNT TODO/FIXME markers in staged files${NC}"
else
    echo -e "${GREEN}โ No TODO/FIXME markers${NC}"
fi

# Final result
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}โ Pre-commit checks FAILED${NC}"
    echo ""
    echo "Fix the issues above and try again."
    echo "To skip these checks (not recommended): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}โ All pre-commit checks passed!${NC}"
    exit 0
fi
